<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Portfolio Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.2rem;
        }

        .upload-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .upload-area {
            border: 3px dashed rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-area:hover {
            border-color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .upload-area.dragover {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .upload-subtext {
            opacity: 0.8;
            font-size: 1rem;
        }

        input[type="file"] {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .category-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .category-item {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
            box-shadow: 0 5px 15px rgba(132, 250, 176, 0.3);
        }

        .category-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .category-value {
            font-size: 1.3rem;
        }

        .insights {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .insights h3 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .insights ul {
            list-style: none;
            padding: 0;
        }

        .insights li {
            background: rgba(255, 255, 255, 0.2);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid white;
        }

        .top-holdings {
            margin: 20px 0;
        }

        .holdings-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .holdings-table th,
        .holdings-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .holdings-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .holdings-table tr:hover {
            background: #f5f5f5;
        }

        .positive {
            color: #4CAF50;
            font-weight: bold;
        }

        .negative {
            color: #f44336;
            font-weight: bold;
        }

        .ai-analysis {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .analyzing {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .error {
            background: #f44336;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä AI Portfolio Analyzer</h1>
            <p>Upload your Excel portfolio and get intelligent insights powered by AI</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Drop your Excel file here or click to browse</div>
                <div class="upload-subtext">Supports .xlsx, .xls files</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing your portfolio data...</p>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
            <div class="dashboard">
                <div class="metric-card">
                    <div class="metric-value" id="totalValue">$0</div>
                    <div class="metric-label">Total Portfolio Value</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalGainLoss">$0</div>
                    <div class="metric-label">Total Gain/Loss</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="totalGainPercent">0%</div>
                    <div class="metric-label">Total Gain %</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="numHoldings">0</div>
                    <div class="metric-label">Holdings Count</div>
                </div>
            </div>

            <div class="section">
                <h2>Portfolio Allocation</h2>
                <div class="chart-container">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>Category Breakdown</h2>
                <div class="category-breakdown" id="categoryBreakdown"></div>
            </div>

            <div class="section">
                <h2>Top Holdings</h2>
                <div class="top-holdings">
                    <table class="holdings-table" id="holdingsTable">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Description</th>
                                <th>Market Value</th>
                                <th>Gain/Loss $</th>
                                <th>Gain/Loss %</th>
                                <th>% of Portfolio</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="ai-analysis" id="aiAnalysis">
                <div class="analyzing">
                    <div class="spinner pulse"></div>
                    <h3>AI is analyzing your portfolio...</h3>
                </div>
            </div>
        </div>
    </div>

    <script>
        let portfolioData = [];
        let categoryData = {};
        let chart = null;

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('Please select a valid Excel file (.xlsx or .xls)');
                return;
            }

            loading.style.display = 'block';
            results.style.display = 'none';
            error.style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    portfolioData = processPortfolioData(jsonData);
                    if (portfolioData.length === 0) {
                        throw new Error('No valid portfolio data found in the file');
                    }
                    
                    analyzePortfolio();
                } catch (err) {
                    console.error('Error processing file:', err);
                    showError('Error processing file: ' + err.message);
                    loading.style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processPortfolioData(rawData) {
            return rawData.map(row => {
                // Handle different possible column name variations
                const getColumnValue = (row, possibleNames) => {
                    for (let name of possibleNames) {
                        if (row[name] !== undefined) return row[name];
                    }
                    return null;
                };

                const symbol = getColumnValue(row, ['Symbol', 'SYMBOL', 'Ticker']);
                const description = getColumnValue(row, ['Description', 'DESCRIPTION', 'Name', 'Company']);
                const marketValue = parseFloat(getColumnValue(row, ['Mkt Val', 'Market Value', 'MKT VAL', 'Value']) || 0);
                const gainLoss = parseFloat(getColumnValue(row, ['Gain $', 'Gain/Loss $', 'GAIN $', 'P&L']) || 0);
                const gainPercent = parseFloat(getColumnValue(row, ['Gain %', 'Gain/Loss %', 'GAIN %', 'P&L %']) || 0);
                const quantity = parseFloat(getColumnValue(row, ['Qty', 'Quantity', 'QTY', 'Shares']) || 0);
                const price = parseFloat(getColumnValue(row, ['Price', 'PRICE', 'Current Price']) || 0);

                if (!symbol || marketValue === 0) return null;

                return {
                    symbol,
                    description: description || symbol,
                    marketValue,
                    gainLoss,
                    gainPercent,
                    quantity,
                    price,
                    category: categorizeStock(symbol, description)
                };
            }).filter(item => item !== null);
        }

        function categorizeStock(symbol, description) {
            const desc = (description || '').toLowerCase();
            const sym = (symbol || '').toLowerCase();

            // ETF patterns
            if (sym.includes('etf') || desc.includes('etf') || desc.includes('fund') || 
                sym.match(/^(spy|qqq|iwm|vti|voo|dia|xle|xlf|xlk|xly|xlp|xli|xlv|xlb|xlu|xlre)/)) {
                return 'ETFs';
            }

            // Tech companies
            if (sym.match(/^(aapl|msft|googl|goog|amzn|meta|tsla|nvda|nflx|adbe|crm|orcl|intc|amd|avgo|qcom|txn|now|intu|mu|amat|lrcx|klac|mrvl|on|swks|tmus|vz|t|dis|zm|uber|lyft|sq|pypl|v|ma|shop|snow|pltr|rblx|coin|hood|rivn|lcid)/) ||
                desc.includes('software') || desc.includes('technology') || desc.includes('semiconductor') ||
                desc.includes('internet') || desc.includes('cloud') || desc.includes('cyber')) {
                return 'Technology';
            }

            // Healthcare
            if (desc.includes('pharma') || desc.includes('biotech') || desc.includes('healthcare') ||
                desc.includes('medical') || desc.includes('drug') || desc.includes('hospital') ||
                sym.match(/^(jnj|pfizer|mrk|abbv|lly|unh|jpm|bmy|gild|amgn|regn|vrtx|biib|celg)/)) {
                return 'Healthcare';
            }

            // Financial services
            if (desc.includes('bank') || desc.includes('financial') || desc.includes('insurance') ||
                desc.includes('credit') || desc.includes('investment') ||
                sym.match(/^(jpm|bac|wfc|c|gs|ms|axa|aig|met|pru|schw|bk|usb|pnc)/)) {
                return 'Financial';
            }

            // Energy
            if (desc.includes('oil') || desc.includes('gas') || desc.includes('energy') ||
                desc.includes('petroleum') || desc.includes('renewable') ||
                sym.match(/^(xom|cvx|cop|slb|oxy|mro|dvn|eog|pxd|kmi)/)) {
                return 'Energy';
            }

            // Consumer goods
            if (desc.includes('retail') || desc.includes('consumer') || desc.includes('food') ||
                desc.includes('beverage') || desc.includes('restaurant') ||
                sym.match(/^(ko|pep|wmt|hd|low|mcd|sbux|nke|pg|jnj|cost)/)) {
                return 'Consumer';
            }

            // Real Estate
            if (desc.includes('reit') || desc.includes('real estate') || desc.includes('property') ||
                sym.match(/^(amt|pld|eqix|wel|dlr|o|reyn|avb|eqr|ess)/)) {
                return 'Real Estate';
            }

            // Industrial
            if (desc.includes('industrial') || desc.includes('aerospace') || desc.includes('defense') ||
                desc.includes('manufacturing') || desc.includes('transportation') ||
                sym.match(/^(ba|cat|ge|mmm|hon|ups|fdx|lmt|rtx|de)/)) {
                return 'Industrial';
            }

            return 'Other';
        }

        function analyzePortfolio() {
            // Calculate summary metrics
            const totalValue = portfolioData.reduce((sum, stock) => sum + stock.marketValue, 0);
            const totalGainLoss = portfolioData.reduce((sum, stock) => sum + stock.gainLoss, 0);
            const totalGainPercent = totalValue > 0 ? (totalGainLoss / (totalValue - totalGainLoss)) * 100 : 0;

            // Group by category
            categoryData = portfolioData.reduce((acc, stock) => {
                if (!acc[stock.category]) {
                    acc[stock.category] = { value: 0, count: 0, gainLoss: 0 };
                }
                acc[stock.category].value += stock.marketValue;
                acc[stock.category].count += 1;
                acc[stock.category].gainLoss += stock.gainLoss;
                return acc;
            }, {});

            // Update dashboard
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalGainLoss').textContent = formatCurrency(totalGainLoss);
            document.getElementById('totalGainPercent').textContent = formatPercent(totalGainPercent);
            document.getElementById('numHoldings').textContent = portfolioData.length;

            // Apply color coding to gain/loss
            const gainLossElement = document.getElementById('totalGainLoss');
            const gainPercentElement = document.getElementById('totalGainPercent');
            if (totalGainLoss >= 0) {
                gainLossElement.style.color = '#4CAF50';
                gainPercentElement.style.color = '#4CAF50';
            } else {
                gainLossElement.style.color = '#f44336';
                gainPercentElement.style.color = '#f44336';
            }

            // Create category breakdown
            createCategoryBreakdown();
            
            // Create chart
            createAllocationChart();
            
            // Create holdings table
            createHoldingsTable();
            
            // Show results
            loading.style.display = 'none';
            results.style.display = 'block';
            
            // Start AI analysis
            analyzeWithAI();
        }

        function createCategoryBreakdown() {
            const container = document.getElementById('categoryBreakdown');
            container.innerHTML = '';

            Object.entries(categoryData).forEach(([category, data]) => {
                const totalValue = portfolioData.reduce((sum, stock) => sum + stock.marketValue, 0);
                const percentage = ((data.value / totalValue) * 100).toFixed(1);
                
                const div = document.createElement('div');
                div.className = 'category-item';
                div.innerHTML = `
                    <div class="category-name">${category}</div>
                    <div class="category-value">${formatCurrency(data.value)}</div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">${percentage}% (${data.count} holdings)</div>
                `;
                container.appendChild(div);
            });
        }

        function createAllocationChart() {
            const ctx = document.getElementById('allocationChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const categories = Object.keys(categoryData);
            const values = categories.map(cat => categoryData[cat].value);
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function createHoldingsTable() {
            const tbody = document.querySelector('#holdingsTable tbody');
            tbody.innerHTML = '';

            // Sort by market value (descending)
            const sortedHoldings = [...portfolioData].sort((a, b) => b.marketValue - a.marketValue);
            const totalValue = portfolioData.reduce((sum, stock) => sum + stock.marketValue, 0);

            sortedHoldings.slice(0, 10).forEach(stock => {
                const row = document.createElement('tr');
                const portfolioPercent = ((stock.marketValue / totalValue) * 100).toFixed(2);
                
                row.innerHTML = `
                    <td><strong>${stock.symbol}</strong></td>
                    <td>${stock.description}</td>
                    <td>${formatCurrency(stock.marketValue)}</td>
                    <td class="${stock.gainLoss >= 0 ? 'positive' : 'negative'}">${formatCurrency(stock.gainLoss)}</td>
                    <td class="${stock.gainPercent >= 0 ? 'positive' : 'negative'}">${formatPercent(stock.gainPercent)}</td>
                    <td>${portfolioPercent}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        async function analyzeWithAI() {
            try {
                const totalValue = portfolioData.reduce((sum, stock) => sum + stock.marketValue, 0);
                const totalGainLoss = portfolioData.reduce((sum, stock) => sum + stock.gainLoss, 0);
                const totalGainPercent = totalValue > 0 ? (totalGainLoss / (totalValue - totalGainLoss)) * 100 : 0;

                // Prepare portfolio summary for AI
                const portfolioSummary = {
                    totalValue: totalValue,
                    totalGainLoss: totalGainLoss,
                    totalGainPercent: totalGainPercent,
                    numHoldings: portfolioData.length,
                    categories: categoryData,
                    topHoldings: portfolioData
                        .sort((a, b) => b.marketValue - a.marketValue)
                        .slice(0, 10)
                        .map(stock => ({
                            symbol: stock.symbol,
                            category: stock.category,
                            marketValue: stock.marketValue,
                            portfolioPercent: (stock.marketValue / totalValue * 100).toFixed(2),
                            gainPercent: stock.gainPercent
                        }))
                };

                const prompt = `Analyze this investment portfolio and provide detailed insights:

Portfolio Summary:
- Total Value: ${formatCurrency(totalValue)}
- Total Gain/Loss: ${formatCurrency(totalGainLoss)} (${formatPercent(totalGainPercent)})
- Number of Holdings: ${portfolioData.length}

Category Breakdown:
${Object.entries(categoryData).map(([cat, data]) => 
    `- ${cat}: ${formatCurrency(data.value)} (${(data.value/totalValue*100).toFixed(1)}%)`
).join('\n')}

Top 10 Holdings:
${portfolioSummary.topHoldings.map(stock => 
    `- ${stock.symbol} (${stock.category}): ${formatCurrency(stock.marketValue)} (${stock.portfolioPercent}% of portfolio, ${formatPercent(stock.gainPercent)} gain)`
).join('\n')}

Please provide:
1. Portfolio diversification analysis
2. Risk assessment based on concentration and sector allocation
3. Performance evaluation
4. Specific recommendations for improvement
5. Potential concerns or red flags
6. Suggestions for rebalancing or new investments

Format your response as a comprehensive analysis with actionable insights.`;

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2000,
                        messages: [
                            { role: "user", content: prompt }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`AI analysis failed: ${response.status}`);
                }

                const data = await response.json();
                const analysis = data.content[0].text;

                displayAIAnalysis(analysis);

            } catch (error) {
                console.error('AI analysis error:', error);
                displayAIAnalysis('Unable to generate AI analysis at this time. Please try again later.');
            }
        }

        function displayAIAnalysis(analysis) {
            const aiSection = document.getElementById('aiAnalysis');
            aiSection.innerHTML = `
                <h3>ü§ñ AI Portfolio Analysis</h3>
                <div style="white-space: pre-line; line-height: 1.6; font-size: 1.1rem;">
                    ${analysis}
                </div>
            `;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        function formatPercent(value) {
            return `${value.toFixed(2)}%`;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>